<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>휴젤 워크숍 · 버스 승하차 및 조 검색</title>
<style>
:root { --maxw: 900px; }
* { box-sizing: border-box; }
body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,"Apple SD Gothic Neo","맑은 고딕",sans-serif; margin:0; background:#f7f7fb; color:#111; }
.header { max-width: var(--maxw); margin:24px auto 0; padding:0 16px; }
.h1 { font-size:20px; font-weight:700; margin:8px 0 4px; }
.sub { color:#666; font-size:14px; margin-bottom:12px; }
.card { max-width:var(--maxw); background:#fff; margin:12px auto; border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
.row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
input[type="text"] { flex:1; min-width:240px; padding:12px 14px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
button { padding:12px 14px; border:none; border-radius:12px; background:#111; color:#fff; font-weight:700; cursor:pointer; }
.table-wrap { overflow:auto; border:1px solid #eee; border-radius:12px; }
table { width:100%; border-collapse:collapse; min-width:760px; }
th, td { padding:10px 12px; border-bottom:1px solid #f0f0f0; text-align:left; font-size:14px; }
th { background:#fafafa; position:sticky; top:0; z-index:1; }
tr:hover td { background:#fcfcff; }
.count { font-size:12px; color:#666; margin:10px 0 0; }
.footer { max-width:var(--maxw); margin:8px auto 24px; padding:0 16px; color:#888; font-size:12px; }
.badge { display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:#eef; color:#225; margin-left:6px; }
.err { color:#c00; font-size:12px; margin-top:6px; white-space:pre-line; }
</style>
</head>
<body>
  <div class="header">
    <div class="h1">휴젤 워크숍 · 버스 승하차 및 조 검색 <span class="badge">Yamoiza</span></div>
    <div class="sub">이름을 입력하면 이름 / 부서 / 소속 / <b>버스 승하차지</b> / <b>오전조(알파벳,숫자)</b> / <b>오후조(알파벳)</b>을 확인할 수 있습니다.</div>
  </div>

  <div class="card">
    <div class="row">
      <input id="q" type="text" placeholder="이름 입력 (예: 홍길동)" />
      <button id="btn" onclick="run()">검색</button>
    </div>
    <div id="err" class="err"></div>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>이름</th><th>부서</th><th>소속</th><th>버스 승하차지</th><th>오전조</th><th>오후조</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <div class="count" id="count"></div>
  </div>

  <div class="footer">© <span id="today"></span> Yamoiza · GitHub Pages</div>

  <!-- SheetJS (엑셀 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.getElementById('today').textContent = new Date().toISOString().slice(0,10);

// 엑셀 경로(레포 내)
const BUS_XLSX_URL   = "./data/bus_records.xlsx?v="   + Date.now();
const GROUP_XLSX_URL = "./data/group_records.xlsx?v=" + Date.now();

const rowsEl = document.getElementById('rows');
const countEl = document.getElementById('count');
const qEl = document.getElementById('q');
const errEl = document.getElementById('err');
const COLUMNS = ["이름","부서","소속","버스 승하차지","오전조","오후조"];

function norm(s){ return (s||"").toString().trim().replace(/\s+/g,"").toLowerCase(); }
function isDigits(s){ return /^[0-9]+$/.test(s); }
function cleanToken(s){ return String(s||"").replace(/\s+/g,"").trim(); }

// ===== 버스 시트 파싱 =====
// 시트명 → 승하차지 매핑
function mapFromBusSheet(sheetName){
  const n = String(sheetName).replace(/\s+/g,"");
  if(n.includes("사당")) return "사당역";
  if(n.includes("종운1호차") || n.includes("1호차")) return "종합운동장역 1호차";
  if(n.includes("종운2호차") || n.includes("2호차")) return "종합운동장역 2호차";
  if(n.includes("종운")) return "종합운동장역";
  return "";
}
// 헤더 추정(상단 50행)
function headerRowIndex(rows){
  const re = /(예약자명|이름|성함)/;
  for(let i=0;i<Math.min(rows.length,50);i++){
    if((rows[i]||[]).some(v => re.test(String(v)))) return i;
  }
  return 0;
}
function parseBusWorkbook(wb){
  const out = [];
  for(const sheetName of wb.SheetNames){
    const ws   = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    if(!rows.length) continue;

    const hIdx = headerRowIndex(rows);
    const head = rows[hIdx].map(x => String(x).trim());
    const place = mapFromBusSheet(sheetName);

    for(let r=hIdx+1; r<rows.length; r++){
      const arr = rows[r] || [];
      const obj = {};
      head.forEach((h,ci)=>{ obj[h] = (arr[ci] ?? ""); });

      const name = obj["예약자명"] || obj["이름"] || obj["성함"] || "";
      if(!name) continue;
      out.push({
        "이름": name,
        "부서": obj["부서명"] || obj["부서"] || "",
        "소속": obj["소속 선택"] || obj["소속"] || "",
        "버스 승하차지": place || (obj["탑승지"] || obj["승하차지"] || "")
      });
    }
  }
  return out;
}

// ===== 조(그룹) 파싱 =====
function isMarkerToken(tok){ return /^[A-Za-z가-힣]+[0-9]+$/.test(cleanToken(tok)); }
function getMarkerFromRow(cells){
  const trimmed = (cells||[]).map(x => cleanToken(x));
  const candidates = trimmed.filter(x => x && isMarkerToken(x));
  const nonEmpty = trimmed.filter(x => x).length;
  if (candidates.length === 1 && nonEmpty <= 2) return candidates[0];
  return "";
}
function looksLikeMemberRow(cells){
  const trimmed = (cells||[]).map(x => String(x).trim());
  const filled = trimmed.filter(v => v!=="").length;
  const firstIsNum = isDigits(trimmed[0]);
  return (filled >= 3) || (firstIsNum && filled >= 2);
}
function pickName(cells){
  for (const idx of [2,1,3,0,4]){
    const v = String(cells[idx] ?? "").trim();
    if(/[가-힣]{2,4}/.test(v) && !/팀|본부|센터|\)/.test(v)) return v;
  }
  for (let i=0;i<cells.length;i++){
    const v = String(cells[i] ?? "").trim();
    if(/[가-힣]{2,4}/.test(v)) return v;
  }
  return "";
}
function pickDept(cells){
  for (const idx of [3,2,4,1,0]){
    const v = String(cells[idx] ?? "").trim();
    if(/팀|본부|센터|\)/.test(v)) return v;
  }
  return "";
}
function pickOrg(cells){
  for (const idx of [1,2,3,0,4]){
    const v = String(cells[idx] ?? "").trim();
    if(v) return v;
  }
  return "";
}
function afternoonFromMarker(marker){
  return cleanToken(marker).replace(/[0-9]/g,""); // 'M2' -> 'M'
}
function parseGroupWorkbook(wb){
  const out = [];
  for(const sheetName of wb.SheetNames){
    const ws   = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    if(!rows.length) continue;

    let marker = "";
    for(let r=0; r<rows.length; r++){
      const row = rows[r] || [];
      const found = getMarkerFromRow(row);
      if(found){ marker = found; continue; }

      if(!marker) continue;
      if(!looksLikeMemberRow(row)) continue;

      const name = pickName(row);
      if(!name) continue;
      const dept = pickDept(row);
      const org  = pickOrg(row);

      out.push({
        "이름": name,
        "부서": dept,
        "소속": org,
        "오전조": marker,
        "오후조": afternoonFromMarker(marker)
      });
    }
  }
  return out;
}

// ===== 통합(버스+조) =====
function combine(busArr, groupArr){
  // 이름 기준 매핑(동명이인 대비: 그룹의 부서/소속과 버스쪽이 여러개면 최대한 매칭)
  const busMap = new Map(); // name -> array of bus entries
  for(const b of busArr){
    const key = b["이름"];
    if(!busMap.has(key)) busMap.set(key, []);
    busMap.get(key).push(b);
  }

  const results = [];
  const usedBusIdx = new Map(); // name -> set of used indices

  function pickBusForGroup(name, dept, org){
    const list = busMap.get(name) || [];
    if(!list.length) return null;
    // 부서/소속 우선 매칭
    let idx = list.findIndex(x => (org && x["소속"] && x["소속"]===org));
    if(idx<0) idx = list.findIndex(x => (dept && x["부서"] && x["부서"]===dept));
    if(idx<0) idx = 0;
    // 사용 마킹
    const used = usedBusIdx.get(name) || new Set();
    // 같은 인덱스가 이미 쓰였으면 다음 후보
    if(used.has(idx)){
      for(let i=0;i<list.length;i++){
        if(!used.has(i)){ idx = i; break; }
      }
    }
    used.add(idx);
    usedBusIdx.set(name, used);
    return list[idx];
  }

  // 1) 그룹 기준으로 생성(조가 있는 사람들)
  for(const g of groupArr){
    const b = pickBusForGroup(g["이름"], g["부서"], g["소속"]);
    results.push({
      "이름": g["이름"],
      "부서": g["부서"] || (b?.["부서"] || ""),
      "소속": g["소속"] || (b?.["소속"] || ""),
      "버스 승하차지": b?.["버스 승하차지"] || "",
      "오전조": g["오전조"],
      "오후조": g["오후조"]
    });
  }

  // 2) 버스만 있는 사람들(조 정보가 없는 경우)
  const namesInGroup = new Set(groupArr.map(g=>g["이름"]));
  for(const [name, list] of busMap){
    if(namesInGroup.has(name)) continue;
    // 버스에 중복이 있어도 한 줄만 대표로
    const b = list[0];
    results.push({
      "이름": name,
      "부서": b["부서"] || "",
      "소속": b["소속"] || "",
      "버스 승하차지": b["버스 승하차지"] || "",
      "오전조": "",
      "오후조": ""
    });
  }

  return results;
}

// ===== UI =====
function render(list){
  rowsEl.innerHTML = "";
  for(const r of list){
    const tr = document.createElement("tr");
    for(const c of COLUMNS){
      const td = document.createElement("td");
      td.textContent = r[c] ?? "";
      tr.appendChild(td);
    }
    rowsEl.appendChild(tr);
  }
  countEl.textContent = list.length ? `${list.length}건 검색됨` : "검색 결과 없음";
}

let DATA = [];
function run(){
  const q = norm(qEl.value);
  const out = q ? DATA.filter(r => norm(r["이름"]).includes(q)) : [];
  render(out);
}
qEl.addEventListener("keydown", e => { if(e.key==="Enter") run(); });

// ===== 로드 순서: 버스 → 그룹 → 통합 =====
Promise.all([
  fetch(BUS_XLSX_URL,   {cache:"no-store"}).then(r=>{ if(!r.ok) throw new Error("버스 엑셀 로드 실패"); return r.arrayBuffer(); }).then(buf=>XLSX.read(buf,{type:'array'})).then(parseBusWorkbook),
  fetch(GROUP_XLSX_URL, {cache:"no-store"}).then(r=>{ if(!r.ok) throw new Error("조 엑셀 로드 실패");   return r.arrayBuffer(); }).then(buf=>XLSX.read(buf,{type:'array'})).then(parseGroupWorkbook)
]).then(([busArr, groupArr])=>{
  DATA = combine(busArr, groupArr);
  errEl.textContent = "";
  render([]);
}).catch(err=>{
  errEl.textContent = "데이터 로드 실패: " + String(err) + "\n(경로/파일명, CDN 차단 여부를 확인해주세요)";
});
</script>
</body>
</html>
